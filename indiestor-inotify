#!/usr/bin/php
<?php

function syslog_notice($msg)
{
	syslog(LOG_NOTICE,$msg);
}

function terminate($msg)
{
	syslog_notice($msg);
	exit(1);
}

function endsWith($str, $needle)
{
	$length = strlen($needle);
	$result=!$length || substr($str, - $length) === $needle;
   	return $result;
}

function isProjectFolder($folder)
{
	if(endsWith($folder,'.shared')) return true;
	if(endsWith($folder,'.avid')) return true;
	return false;
}


syslog_notice("indiestor-inotify running");

require_once(dirname(__FILE__).'/lib/inotify/InEvent.php');

$inEvent=new InEvent();
syslog_notice($inEvent->toString());

#if(!$inEvent->isDir) terminate("object concerned '{$inEvent->fsObject}' not a directory");
if($inEvent->watchType=="MAIN" && !isProjectFolder($inEvent->fsObject))
	terminate("folder concerned '{$inEvent->fsObject}' not a project folder");

require_once(dirname(__FILE__).'/lib/admin/etcfiles/EtcPasswd.php');
require_once(dirname(__FILE__).'/lib/admin/etcfiles/EtcGroup.php');

//find user for folder
$homeFolder=$inEvent->homeFolder();
$etcPasswd=EtcPasswd::instance();
$user=$etcPasswd->findUserByHomeFolder($homeFolder);
if($user==null) terminate("Cannot find user for home folder '$homeFolder'");
$userName=$user->name;
syslog_notice("user is: '$userName'");

//find group for user
$etcGroup=EtcGroup::instance();
$group=$etcGroup->findGroupForUserName($userName);
if($group==null) terminate("Cannot find group for user '$userName'");
$groupName=$group->name;
syslog_notice("group is: '$groupName'");

//retrieve all group members
$members=$etcPasswd->findUsersForEtcGroup($group);

require_once(dirname(__FILE__).'/lib/inotify/reshare.php');
share($groupName,$members);

