#!/usr/bin/php
<?php
fclose(STDIN);
fclose(STDOUT);
fclose(STDERR);
$outputFile=dirname(__FILE__).'/incron.log';
$STDIN = fopen('/dev/null', 'r');
$STDOUT = fopen($outputFile,'a');
$STDERR = fopen($outputFile,'a');

ini_set('display_errors','On');

$date=date(DATE_RFC822);
$watchType=$argv[1];
$folderWatched=$argv[2];
$fsObject=$argv[3];
$events=$argv[4];

require_once('lib/inotify/InotifyEventHandler.php');

$inMovePendingPath=dirname(__FILE__).'/in_move_pending';
if(!is_dir($inMovePendingPath)) mkdir($inMovePendingPath);
$inotifyEventHandler=new InotifyEventHandler($inMovePendingPath);

//process number
$pid=getmypid();

echo "pid=$pid folder='$folderWatched' type='$watchType' object='$fsObject' events='$events'\n";

try
{
	$decision=$inotifyEventHandler->decision($watchType,$folderWatched,$fsObject,$events);
}
catch(Exception $e)
{
	$decision='ERROR:'.$e->getMessage();
}

if($decision instanceof RenameOperation)
{
	$from=$decision->from;
	$to=$decision->to;
	$decision="RENAME '$from' TO '$to'";
}

echo "====>pid=$pid decision=$decision\n";


