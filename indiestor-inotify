#!/usr/bin/php
<?php

/*
        Indiestor inotify program

	Written by Erik Poupaert, erik@sankuru.biz
        Commissioned at peopleperhour.com 
        By Alex Gardiner, alex.gardiner@canterbury.ac.uk
*/

require_once(dirname(__FILE__).'/lib/inotify/InEvent.php');
require_once(dirname(__FILE__).'/lib/admin/etcfiles/EtcPasswd.php');
require_once(dirname(__FILE__).'/lib/admin/etcfiles/EtcGroup.php');
require_once(dirname(__FILE__).'/lib/admin/action-engine/Incrontab.php');
require_once(dirname(__FILE__).'/lib/inotify/syslog.php');
require_once(dirname(__FILE__).'/lib/inotify/SharingStructure.php');
require_once(dirname(__FILE__).'/lib/inotify/LockingMechanism.php');

syslog_notice_start_running();

//prepare commandline args
$inEvent=new InEvent();

//only handle project folders or Avid MediaFiles folder
if($inEvent->watchType=='MAIN' && 
	!SharingStructure::isProjectFolder($inEvent->fsObject) &&
	$inEvent->fsObject!='Avid MediaFiles'
) terminate("folder concerned '{$inEvent->fsObject}' not a project folder");

//find user for folder
$homeFolder=$inEvent->homeFolder();
$etcPasswd=EtcPasswd::instance();
$user=$etcPasswd->findUserByHomeFolder($homeFolder);
if($user==null) terminate("Cannot find user for home folder '$homeFolder'");
$userName=$user->name;

//find group for user
$etcGroup=EtcGroup::instance();
$group=$etcGroup->findGroupForUserName($userName);
if($group==null) terminate("Cannot find group for user '$userName'");
$groupName=$group->name;

//we know user and group now
syslog_notice("user is: '$userName' group is: '$groupName'");

//retrieve all group members
$members=$etcPasswd->findUsersForEtcGroup($group);

//MAIN: start resharing
if($inEvent->watchType=='MAIN')
{
	$lockingMechanism=new LockingMechanism($groupName);
	$lockingMechanism->lock();
	do
	{
		SharingStructure::reshare($groupName,$members);
	}
	while($lockingMechanism->mustReRun());
	$lockingMechanism->unlock();
}

define('INDIESTOR_LOCKING_PID','indiestor_locking_pid');

function avbFile_lock($avbFile,$userName,$groupName,$pid)
{
	SharingStructure::fixProjectFsObjectOwnership($groupName,$userName,$avbFile);
	SharingStructure::fixFsObjectPermissions($avbFile,'640');
	$lockingPid=avbFile_lockingPid($avbFile);
	if($lockingPid!=$pid)
		shell_exec("setfattr -n user.".INDIESTOR_LOCKING_PID." -v $pid $avbFile");
}

function avbFile_unlock($avbFile,$userName,$groupName)
{
	SharingStructure::fixProjectFsObjectOwnership($groupName,$userName,$avbFile);
	SharingStructure::fixFsObjectPermissions($avbFile,'660');
	shell_exec("setfattr -x user.".INDIESTOR_LOCKING_PID." $avbFile");
}

function avbFile_lockingPid($avbFile)
{
	$lockingPid=trim(shell_exec("getfattr $avbFile -n user.".INDIESTOR_LOCKING_PID." --only-values 2> /dev/null"));
	if(empty($lockingPid)) return null;
	else return $lockingPid;
}

//PROJ: lock or unlock avid bin
if($inEvent->watchType=='PROJ')
{
	//only handle .avb files
	if(!SharingStructure::endsWith($inEvent->fsObject,'.avb')) return;

	$avbFile=$inEvent->folderWatched.'/'.$inEvent->fsObject;
	$lockingPid=avbFile_lockingPid($avbFile);
	if($lockingPid!=null)
		if(!file_exists("/proc/$lockingPid"))
			avbFile_unlock($avbFile,$userName,$groupName);

	if($inEvent->event=='IN_ACCESS' || $inEvent->event=='IN_MODIFY' || $inEvent->event=='IN_CREATE')
	{
		$openingUser=trim(shell_exec("fuser -u '$avbFile' 2>&1 | sed 's/.*(\(.*\))/\\1/'"));
		$openingPid=trim(shell_exec("fuser '$avbFile' 2>&1 | sed 's/.*:\(.*\)/\\1/'"));

		if(!file_exists("/proc/$openingPid")) return;

		if($group->isMember($openingUser))
		{
			avbFile_lock($avbFile,$openingUser,$groupName,$openingPid);
		}
	}
}

//regenerate incrontab for MXF events
if($inEvent->watchType=='MXF' && $inEvent->fsObject=='Avid MediaFiles')
{
	syslog_notice('Regenerating incrontab (MXF)');
	Incrontab::generate();
}

//regenerate incrontab for PROJ events
if($inEvent->watchType=='MAIN' && SharingStructure::isProjectFolder($inEvent->fsObject))
{
	syslog_notice('Regenerating incrontab (MAIN)');
	Incrontab::generate();
}

//notify end run
syslog_notice_end_running();

