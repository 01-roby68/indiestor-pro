#!/usr/bin/php
<?php

function syslog_notice($msg)
{
	syslog(LOG_NOTICE,$msg);
}

function syslog_notice_end_running()
{
	syslog_notice('indiestor, end run');
}

function terminate($msg)
{
	syslog_notice($msg);
	syslog_notice_end_running();
	exit(1);
}

function endsWith($str, $needle)
{
	$length = strlen($needle);
	$result=!$length || substr($str, - $length) === $needle;
   	return $result;
}

function isProjectFolder($folder)
{
	if(endsWith($folder,'.shared')) return true;
	if(endsWith($folder,'.avid')) return true;
	return false;
}


syslog_notice("indiestor-inotify running");

require_once(dirname(__FILE__).'/lib/inotify/InEvent.php');

//fix argv for MXF
if($argv[1]=='MXF')
{
	$argv[2]=$argv[2].' '.$argv[3];
	$argv[3]=$argv[4];
	$argv[4]=$argv[5];
	$argv[5]='';
}

syslog_notice("ARGS: {$argv[1]},{$argv[2]},{$argv[3]},{$argv[4]},{$argv[5]}");

$inEvent=new InEvent();

if($inEvent->watchType=='MAIN' && !isProjectFolder($inEvent->fsObject) && $inEvent->fsObject!='Avid MediaFiles')
	terminate("folder concerned '{$inEvent->fsObject}' not a project folder");

require_once(dirname(__FILE__).'/lib/admin/etcfiles/EtcPasswd.php');
require_once(dirname(__FILE__).'/lib/admin/etcfiles/EtcGroup.php');

//find user for folder
$homeFolder=$inEvent->homeFolder();
$etcPasswd=EtcPasswd::instance();
$user=$etcPasswd->findUserByHomeFolder($homeFolder);
if($user==null) terminate("Cannot find user for home folder '$homeFolder'");
$userName=$user->name;
syslog_notice("user is: '$userName'");

//find group for user
$etcGroup=EtcGroup::instance();
$group=$etcGroup->findGroupForUserName($userName);
if($group==null) terminate("Cannot find group for user '$userName'");
$groupName=$group->name;
syslog_notice("group is: '$groupName'");

//retrieve all group members
$members=$etcPasswd->findUsersForEtcGroup($group);

require_once(dirname(__FILE__).'/lib/inotify/reshare.php');
syslog_notice("resharing group '$groupName'");
share($groupName,$members);

//regenerate incrontab for MXF events
if($inEvent->watchType=='MXF' || $inEvent->fsObject=='Avid MediaFiles')
{
	require_once(dirname(__FILE__).'/lib/admin/action-engine/Incrontab.php');
	syslog_notice('Regenerating incrontab');
	Incrontab::generate();
}

//notify end run
syslog_notice_end_running();

